"use strict";var typeValue="",stack=[];$(".main-body .page-wrapper").find("#adjustment-add,#card-with-header-buttons").length&&($(".js-example-basic-single").select2(),$("#card-with-header-buttons select").prop("disabled",!0)),$(function(){$("#transferTbl").DataTable({responsive:!0,language:{url:app_locale_url},paging:!1,searching:!1,bInfo:!1,ordering:!1})});let global_source_id,global_type,preQuantity=0;function deleteAddedRows(){$(".addedRow").each(function(){$(this).closest("tr").remove()})}function in_array(t,e){for(var a=0;a<e.length;a++)if(e[a]==t)return!0;return!1}function calculateTotalQty(){var t=0;return $(".no_units").each(function(){t+=parseFloat($(this).val()?validateNumbers($(this).val()):0)}),0==t?(swal(jsLang("Please select at least one item."),{icon:"error",buttons:[!1,jsLang("Ok")]}),$("#btnSubmit").attr("disabled","true")):t>0&&$("#btnSubmit").removeAttr("disabled"),t}if($(document).on("keydown",".no_units",function(t){preQuantity=$(this).val()}),$(function(){$(document).on("click","#adjustment-add, #card-with-header-buttons",function(t){t.target.id,$("#no_div").hide()})}),$(function(){$("#datepicker").daterangepicker(dateSingleConfig(),function(t,e){var a=moment(t,"MMMM D, YYYY").format(dateFormat);$("#datepicker").val(a)})}),$(document).ready(function(){$(".error").hide(),$(window).keydown(function(t){if(13==t.keyCode)return t.preventDefault(),!1})}),$(document).ready(function(t){$("#adjustment-add #transferTbl").on("click",".delete_item",function(){var t=$(this).attr("id");stack=jQuery.grep(stack,function(e){return e!=t}),$(this).closest("tr").remove();var e=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(e)),$("#total_quantity").val(e)})}),$(document).ready(function(t){$("#card-with-header-buttons #transferTbl").on("click",".delete_item",function(){var t=$(this).attr("data-id");(stack=jQuery.grep(stack,function(e){return e!=t})).pop(t),$(this).closest("tr").remove(),stack.splice($(this).attr("data-id")),totalQty=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(totalQty)),$("#total_quantity").val(getDecimalNumberFormat(totalQty))})}),$(document).on("click","#btnSubmit",function(){$("input[type=text]").each(function(){if($(this).hasClass("error"))return $(this).focus(),!1})}),$(document).on("click",".no_units",function(t){$(".labelMindata-max").css("display","none")}),$(document).on("click",function(t){$(".labelMindata-max").css("display","none"),$(".labelMindata-max").css("position","fixed")}),$(document).on("keyup change input","#adjustment-add .no_units",function(t){var e=validateNumbers($(this).val()),a=$(this).attr("data-id");"STOCKOUT"==$("#type").val()&&$.ajax({method:"POST",url:SITE_URL+"/stock_adjustment/check-item-qty",data:{item_id:a,_token:token,source:$("#location").val()}}).done(function(t){t=JSON.parse(t);var i=$("#qty_"+a).attr("data-max");if(Number(e)>Number(i))return $("#qty_"+a).val(preQuantity),swal(t.qty+" "+jsLang("item(s) available in stock"),{icon:"error"}),$("#qty_"+a).val(preQuantity),n=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(n)),getDecimalNumberFormat(preQuantity)});var n=calculateTotalQty();$("#total_qty").text(n),$("#total_quantity").val(n)}),$(document).on("keyup change input","#card-with-header-buttons .no_units",function(t){var e=parseFloat(validateNumbers($(this).val())),a=$(this).attr("data-id"),n=parseFloat($(this).attr("old-qty")?$(this).attr("old-qty"):0);"STOCKOUT"==$("#type").val()&&$.ajax({method:"POST",url:SITE_URL+"/stock_adjustment/check-item-qty",data:{item_id:a,_token:token,source:$("#location").val()}}).done(function(t){t=JSON.parse(t);if($("#qty_"+a).attr("data_max",data_max>0?data_max:Number(n)+Number(t.qty)),Number(e)>Number(n)+Number(t.qty))return swal(getDecimalNumberFormat(t.qty)+" "+jsLang("item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),$("#qty_"+a).val(preQuantity),totalQty=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(totalQty)),getDecimalNumberFormat(preQuantity)}),totalQty=calculateTotalQty(),$("#total_qty").text(getDecimalNumberFormat(totalQty)),$("#total_quantity").val(getDecimalNumberFormat(totalQty))}),$(".main-body .page-wrapper").find("#card-with-header-buttons").length&&$("#card-with-header-buttons #transferForm").validate({rules:{type:{required:!0},location:{required:!0},date:{required:!0},"item_quantity[]":{required:!0},"new_item_quantity[]":{required:!0}},submitHandler:function(){return 0!=document.getElementsByClassName("addedRow").length||(swal(jsLang("Please select at least one item."),{icon:"error",buttons:[!1,jsLang("Ok")]}),!1)}}),$(".main-body .page-wrapper").find("#adjustment-add").length&&$("#adjustment-add #transferForm").validate({rules:{type:{required:!0},location:{required:!0},date:{required:!0},"quantity[]":{required:!0}},messages:{"quantity[]":{required:""}},submitHandler:function(){return 0!=document.getElementsByClassName("addedRow").length||(swal({text:jsLang("Please select at least one item."),icon:"error",buttons:[!1,jsLang("Ok")]}),!1)}}),$("#adjustment-add #location").on("change",function(){stack=[],$(".error").hide(),$("#errorMessage").text(" ");$("#location").val(),$(this).val();null!=global_source_id&&1==$("#transferTbl tr").hasClass("addedRow")?swal({title:jsLang("Are you sure?"),text:jsLang("Change of location will reset added products/services, please confirm you really want to do this."),icon:"warning",buttons:[jsLang("Cancel"),jsLang("Ok")],dangerMode:!0}).then(t=>{t?(global_source_id=$("#location").val(),$(".closeRow").trigger("click"),deleteAddedRows(),$("#total_qty").text("0")):($("#location").val(global_source_id),$("#location").trigger("change.select2"))}):global_source_id=$("#location").val(),""!=global_source_id&&$("#source-error").css("display","none"),$("#type").val()&&$("#location").val()&&$("#error_message").html("")}),$("#adjustment-add #type").on("change",function(){stack=[],$(".error").hide(),$("#errorMessage").text(" "),typeValue=$("#type").val(),null!=global_type?swal({title:jsLang("Are you sure?"),text:jsLang("Change of location will reset added products/services, please confirm you really want to do this."),icon:"warning",buttons:[jsLang("Cancel"),jsLang("Ok")],dangerMode:!0}).then(t=>{t?(global_type=$("#type").val(),$(".closeRow").trigger("click"),deleteAddedRows(),$("#total_qty").text("0")):($("#type").val(global_type),$("#type").trigger("change.select2"))}):global_type=$("#type").val(),""!=global_type&&$("#type-error").css("display","none")}),$(document).on("click","#csv, #pdf",function(t){t.preventDefault(),window.location=SITE_URL+"/stock/adjustment-"+this.id+"?to="+$("#endto").val()+"&from="+$("#startfrom").val()+"&trans_type="+$("#trans_type").val()+"&location="+$("#destination").val()}),$(".list-container #dataTableBuilder").addClass("stock-transfer-list"),$(".main-body .page-wrapper").find("#adjustment-add").length&&($("#adjustment-add #search").autocomplete({delay:500,position:{my:"left top",at:"left bottom",collision:"flip"},source:function(t,e){var a=$("#type").val(),n=$("#location").val();return a?($("#error_message").html(""),a&&!n?($("#error_message").html(jsLang("Please select Source")),$("#location").select2("open"),!1):void $.ajax({url:SITE_URL+"/adjustment/search",type:"post",dataType:"json",data:{_token:token,search:t.term,location:n},success:function(t){if(1==t.status_no){$("#val_item").html();t=t.items;$("#no_div").css("display","none"),e($.map(t,function(t){return{id:t.id,value:t.name,available:t.available,is_stock_managed:t.is_stock_managed}}))}else $(".ui-menu-item").remove(),$("#no_div").css("display","block")}})):($("#error_message").html(jsLang("Please select Type and Source")),$("#type").select2("open"),a&&($("#location").select2("open"),$("#error_message").html("")),$("html, body").animate({scrollTop:0},500),!1)},select:function(t,e){var a=e.item;if(a.id){if(1==a.is_stock_managed&&a.available<=0&&"STOCKOUT"==$("#type").val())return swal(a.available+" "+jsLang("item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),!1;if(in_array(a.id,stack))$("#qty_"+a.id).val(function(t,e){return e=validateNumbers(e),"STOCKOUT"==$("#type").val()&&parseFloat(a.available)<parseFloat(e)+1?(swal(a.available+" "+jsLang("item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),getDecimalNumberFormat(e)):Number.isInteger(parseFloat(e))?($("#qty_"+a.id).trigger("change"),parseFloat(++e)):($("#qty_"+a.id).trigger("change"),getDecimalNumberFormat(++e))});else{var n='<tr class="addedRow" id="rowid'+a.id+'"><td class="text-center">'+a.value+'</div><input type="hidden" name="description[]" value="'+a.value+'"><input type="hidden" name="stock[]" value="'+a.id+'"></td><td><input class="form-control text-center no_units positive-float-number" stock-id="'+a.id+'" id="qty_'+a.id+'" data-id="'+a.id+'" type="text" name="quantity[]" value="1"><label id="qty_'+a.id+'-error" class="error labelMindata-max" for="qty_'+a.id+'"></label><div id="errorMessage-'+a.id+'" class="color_red f-bold"><input type="hidden" name="id[]" value="'+a.id+'"></td><td class="text-center"><button id="'+a.id+'" class="btn btn-xs btn-danger delete_item"><i class="feather icon-trash-2"></i></button></td></tr>';stack.length<=0&&$(".dataTables_empty").parent().remove(),$("#item-body").append(n),stack.push(a.id)}$(this).val(""),"STOCKOUT"==$("#type").val()&&$.ajax({method:"POST",url:SITE_URL+"/stock_adjustment/check-item-qty",data:{item_id:a.id,_token:token,source:$("#location").val()}}).done(function(t){t=JSON.parse(t);$("#qty_"+t.id).attr("data-max",t.qty);var e=$("#qty_"+a.id).val();if(t.qty<Number(e)){$("#qty_"+t.id).attr("data-max",t.qty),$("#qty_"+a.id).trigger("change"),$("#errorMessage").html(t.message);var n=calculateTotalQty();$("#total_qty").text(getDecimalNumberFormat(n))}});var i=calculateTotalQty();return $("#total_qty").text(getDecimalNumberFormat(i)),$("#total_quantity").val(i),!1}},minLength:1,autoFocus:!0}).on("focus",function(){$(this).autocomplete("search")}).autocomplete("instance")._renderItem=function(t,e){var a;return a=1==e.is_stock_managed?e.available:"-",$("<li>").append("<div>"+e.value+"<br>"+jsLang("Available")+" : "+a+"</div>").appendTo(t)}),$(".main-body .page-wrapper").find("#card-with-header-buttons").length){var totalQty=0,oldQuantity=0,data_max=0;$("#card-with-header-buttons #search").autocomplete({delay:500,position:{my:"left top",at:"left bottom",collision:"flip"},source:function(t,e){$("#type").val();var a=$("#location").val();$.ajax({url:SITE_URL+"/adjustment/search",type:"post",dataType:"json",data:{_token:token,adjustment_id:adjustmentId,type:adjustmentType,search:t.term,location:a},success:function(t){if(1==t.status_no){$("#val_item").html();t=t.items;$("#no_div").css("display","none"),e($.map(t,function(t){return{id:t.id,value:t.name,available:t.available,is_stock_managed:t.is_stock_managed}}))}else $(".ui-menu").remove(),$("#no_div").css("display","block")}})},select:function(t,e){var a=e.item;if(a.id){if("STOCKOUT"==$("#type").val()&&1==a.is_stock_managed&&a.available<=0)return swal(a.available+" "+jsLang("item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}),!1;if(in_array(a.id,stack)){var n=$("#qty_"+a.id).attr("data-max"),i=validateNumbers($("#qty_"+a.id).val());1==a.is_stock_managed&&n<parseFloat(i)+1?swal(n+" "+jsLang("item(s) available in stock"),{icon:"error",buttons:[!1,jsLang("Ok")]}):Number.isInteger(parseFloat(i))?$("#qty_"+a.id).val(parseInt(++i)):$("#qty_"+a.id).val(getDecimalNumberFormat(++i))}else{var o='<tr class="addedRow" id="rowid'+a.id+'"><td class="text-center">'+a.value+'<input type="hidden" name="new_description[]" value="'+a.value+'"><input type="hidden" name="new_stock[]" value="'+a.id+'"></td><td> <input class="form-control text-center no_units positive-float-number" data-id="'+a.id+'" data-rate="'+a.price+'" type="text" id="qty_'+a.id+'" name="new_item_quantity[]" value="1"><label id="qty_'+a.id+'-error" class="error labelMindata-max" for="qty_'+a.id+'"></label><div id="errorMessage-'+a.id+'"class="color_red f-bold"></div><input type="hidden" name="new_item_id[]" value="'+a.id+'"></td><td class="text-center"><button id="'+a.id+'" class="btn btn-xs btn-danger delete_item"><i class="feather icon-trash-2"></i></button></td></tr>';$("#item-body").append(o),stack.push(a.id)}$(this).val("");var l=calculateTotalQty();return $("#total_qty").text(getDecimalNumberFormat(l)),$("#total_quantity").val(getDecimalNumberFormat(l)),!1}},minLength:1,autoFocus:!0}).on("focus",function(){$(this).autocomplete("search")}).autocomplete("instance")._renderItem=function(t,e){var a;return a=1==e.is_stock_managed?e.available:"-",$("<li>").append("<div>"+e.value+"<br>"+jsLang("Available")+" : "+a+"</div>").appendTo(t)}}$("#stock-details-container").find("#dataTableBuilder").length&&$(function(){$("#dataTableBuilder").DataTable({responsive:!0,language:{url:app_locale_url},paging:!1,searching:!1,bInfo:!1,ordering:!1})});